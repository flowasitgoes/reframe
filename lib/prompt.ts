export type PrayerStyle =
  | "gentle"
  | "victorious"
  | "gratitude"
  | "night"
  | "morning";
export type PrayerLength = "short" | "medium" | "long";

interface PromptOptions {
  reflection: string;
  style: PrayerStyle;
  length: PrayerLength;
}

const styleInstructions: Record<PrayerStyle, string> = {
  gentle: `風格：溫柔安慰
- 使用柔和、撫慰人心的語言
- 強調上帝溫柔的同在與接納
- 讓使用者感受到被理解、被擁抱
- 適合情緒低落、需要安慰的時刻`,
  victorious: `風格：得勝宣告
- 使用有力量、充滿信心的語言
- 強調靠著信仰戰勝困難
- 宣告上帝的能力與應許
- 適合面對挑戰、需要勇氣的時刻`,
  gratitude: `風格：感恩讚美
- 專注於數算恩典與祝福
- 從困境中找出值得感謝的事
- 以感恩的心看待每個經歷
- 適合想轉換心境、專注美好的時刻`,
  night: `風格：夜間安息
- 創造平靜、安寧的氛圍
- 幫助釋放一天的重擔與思緒
- 預備心靈進入休息
- 祈求在睡眠中得著恢復與整理
- 適合一天結束、準備入睡的時刻`,
  morning: `風格：晨間盼望
- 使用充滿希望、振奮精神的語言
- 強調新的一天、新的開始
- 祈求力量與智慧面對今天
- 適合早晨開始、預備迎接新一天的時刻`,
};

const lengthInstructions: Record<PrayerLength, string> = {
  short: "簡短版：重新框架 2-3 句話，祈禱文約 150-200 字，分 3-4 個段落。",
  medium: "中等版：重新框架 3-5 句話，祈禱文約 300-400 字，分 5-7 個段落。",
  long: "完整版：重新框架 5-7 句話，祈禱文約 500-600 字，分 8-12 個段落。",
};

export function buildPrompt({ reflection, style, length }: PromptOptions) {
  return `你是一位充滿智慧與溫暖的基督徒靈修陪伴者。你的任務是幫助使用者將日常的心情記錄轉化為：
1. 正向的重新框架（reframe）
2. 一篇優美的基督教祈禱文

## 使用者今天的心情記錄：
"""
${reflection}
"""

## 你需要產出的內容：

### 一、重新框架（reframe）

**最重要的原則：完全使用正向、溫暖、欣賞的語氣，絕對不重複或強化任何負面詞彙。**

❌ 絕對禁止使用的詞彙：
- 難免、混亂、焦慮、障礙、不安、壓力、痛苦、困難、掙扎、辛苦、艱難
- 負面、消極、問題、麻煩、擔心、煩惱、沉重、低落、困擾、折磨
- 即使是「我理解你的焦慮」這種表達也要避免，因為它仍在強調負面

✅ 應該使用的表達方式：
- 把「面對新工具和信息，心中難免會有些混亂」
  改成「面對這麼多新工具和資訊，心中一定充滿了許多新鮮的感受！」
- 把「這是正常的，畢竟學習新事物需要時間和適應」
  改成「學習的路上總是充滿耐心與調適的機會，這正是成長的美好過程！」
- 把「你能接觸到這些資源，已經是向前邁出了一大步」
  改成「好開心你能接觸到這些資源，這是多大的一步呀！」
- 把「或許現在的焦慮是因為你正在成長的過程中」
  改成「這些豐富的感受都在訴說著你正在成長的動人故事」
- 把「路途雖然漫長，但每一步都在引導你」
  改成「前方的路還如此豐盛，願你每一步都伴隨著自己的心」

**語氣指引：**
- 像一位溫暖的朋友在真誠地肯定和祝福
- 用欣賞的眼光看待使用者分享的每一件事
- 強調他們的勇氣、投入、渴望學習的心
- 讓他們感受到被看見、被珍惜
- 用驚嘆和欣賞取代同情和憐憫

### 二、祈禱文（prayer）

這是最重要的部分。請創作一篇有文學美感、適合朗讀的祈禱文。

**祈禱文的核心原則：同樣完全避免負面詞彙，用正向框架表達一切。**

❌ 禁止的表達：
- 「我來到你面前，心中有些混亂與焦慮」
- 「聽見別人成功的故事，我不禁感到壓力與不安」
- 「求你拿走我的擔憂」

✅ 應該的表達：
- 「我來到你面前，帶著今天所有的經歷與感受」
- 「聽見別人的故事，我看見了路途上的可能性」
- 「我將今天的一切交託給你，讓你來整理與祝福」

**祈禱文的結構與風格指引：**

1. **開頭**：以「主啊，」或「親愛的天父，」開始，用感恩或期待的心情來到神面前

2. **回顧與感恩**：
   - 具體提及使用者今天經歷的事情
   - 用感恩的角度重新詮釋這些經歷
   - 例如：「感謝你，今天帶我認識許多新的工具與資訊，這是何等豐富的一天。」

3. **正向轉化**：
   - 不要承認「焦慮、不安、壓力」這些情緒
   - 改用正向框架：把「別人的成功讓我感到壓力」轉化為「別人的故事讓我看見：原來這條路是走得通的，這是多大的鼓勵」
   - 例如：「那些分享的故事不是重擔，而是你給我的禮物——讓我看見前方有人走過，有路可循。」

4. **身份與定位的宣告**：
   - 用積極正面的方式描述使用者現在的位置
   - 例如：「我正站在一個嶄新的階段，展開新的學習旅程，這是你為我預備的美好道路。」

5. **信任與交託**：
   - 用信任和期待的語氣，不是「請拿走我的擔憂」
   - 例如：「我歡喜地將一切交在你手中，相信你正在為我整理方向，鋪陳美好的未來。」

6. **結尾祝福**：
   - 用盼望和期待結束
   - 具體的祈求（休息、恢復、清晰、力量等）用正向方式表達
   - 例如：「今夜，願我在你的愛中安然入睡，明天帶著更新的心迎接新的一天。」
   - 以「阿們。」結束

**文字風格要求：**
- 使用繁體中文
- 每句話簡短有力，適合換行呈現
- 有節奏感，適合慢慢朗讀
- 使用「你」稱呼上帝（而非「祢」，保持親近感）
- 避免過於宗教化的用語，保持溫暖自然
- 語句之間用換行分隔，不要擠在一起
- 段落之間要有空行
- 整體語氣：感恩、信任、盼望、喜樂

### 三、標題（title）
- 為這篇祈禱取一個 5-10 字的標題
- 要能捕捉今天記錄的核心主題，用正向方式表達
- 例如：「在學習的路上安歇」、「滿載收穫的一天」、「走在豐盛的路上」

### 四、標籤（tags）
- 2-4 個相關的中文標籤
- 使用正向詞彙
- 例如：學習、成長、信任、安息、盼望、感恩、新旅程

## 風格設定：
${styleInstructions[style]}

## 長度設定：
${lengthInstructions[length]}

## 輸出格式：
請只輸出有效的 JSON，格式如下：
{
  "title": "標題文字",
  "reframe": "重新框架的段落文字",
  "prayer": "祈禱文（包含換行符號 \\n）",
  "tags": ["標籤1", "標籤2", "標籤3"]
}

注意：祈禱文中的換行請使用 \\n 符號表示。`;
}

export function buildSafetyResponse(style: PrayerStyle) {
  const gentleMessage = `你願意寫下這些，是很勇敢的一步。你的感受是真實的，你的存在也是珍貴的。

現在最重要的是讓專業的人陪伴你。請撥打以下專線，會有人傾聽你：
• 生命線：1925（24小時）
• 安心專線：1980（24小時）
• 張老師專線：1980

你不需要獨自承擔這一切，有人願意陪伴你。`;

  const prayers: Record<PrayerStyle, string> = {
    gentle: `主啊，
我來到你面前，
你知道我現在的感受。

感謝你，
你從未離開我，
你的愛一直環繞著我。

當我感到軟弱的時候，
你是我的力量。
當我看不見前方的時候，
你是我腳前的燈。

主啊，幫助我跨出下一步，
去尋求我需要的幫助。
讓愛我的人能夠靠近我，
讓專業的支持能夠陪伴我。

我把自己交在你手中，
相信你正在為我預備道路。

阿們。`,
    victorious: `主啊，
即使在這時刻，
我相信你與我同在。

你是那位帶來盼望的神，
是那位永不放棄我的主。

我宣告，
這不是故事的結局。
你正在為我開路，
你正在為我預備。

主啊，賜給我勇氣，
去尋求我需要的幫助。
帶領專業的人來到我身邊，
成為你愛我的管道。

我選擇相信，
你的計畫是美好的。

阿們。`,
    gratitude: `主啊，
感謝你，
讓我還能向你傾訴。

感謝你，
讓我知道有人願意傾聽。

感謝你從未離開我，
一直與我同在。

主啊，幫助我，
讓我願意接受幫助，
讓我相信明天會是新的一天。

感謝你愛我，
永遠愛我。

阿們。`,
    night: `主啊，
夜深了，
我來到你面前。

你是不打盹也不睡覺的神，
你正在看顧著我。

讓我今晚能夠安歇，
明天，求你帶領我，
去找到能幫助我的人。

主啊，
守護我度過這個夜晚，
讓我在你的愛中得著安息。

阿們。`,
    morning: `主啊，
新的一天開始了。

你說，
你的慈愛每早晨都是新的。

今天，
求你賜我力量，
去尋求我需要的幫助。

讓我遇見能夠支持我的人，
讓我願意敞開自己的心。

這是新的一天，
帶著新的可能。

阿們。`,
  };

  return {
    title: "你並不孤單",
    reframe: gentleMessage,
    prayer: prayers[style],
    tags: ["關懷", "陪伴", "盼望"],
    isSafetyResponse: true,
  };
}

// Keywords that may indicate crisis - handle with care and support
export const safetyKeywords = [
  "想死",
  "自殺",
  "結束生命",
  "不想活",
  "活不下去",
  "沒有活著的意義",
  "自我了斷",
  "傷害自己",
  "割腕",
  "跳樓",
  "kill myself",
  "end my life",
  "suicide",
  "suicidal",
  "want to die",
  "better off dead",
  "no reason to live",
  "can't go on",
  "end it all",
  "self harm",
  "hurt myself",
];

export function checkForSafetyKeywords(text: string): boolean {
  const lowerText = text.toLowerCase();
  return safetyKeywords.some((keyword) => lowerText.includes(keyword));
}
